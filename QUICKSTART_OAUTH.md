# ðŸš€ Google OAuth Quick Start Guide (PKCE)

Get Google OAuth working with the secure PKCE flow in 5 minutes!

## âœ… What's Done

The frontend OAuth implementation is **100% complete** using the **PKCE (Proof Key for Code Exchange) flow**. This is the most secure OAuth 2.0 implementation.

---

## ðŸ“‹ Overview

### What is PKCE?

PKCE (Proof Key for Code Exchange) is an extension to the OAuth 2.0 Authorization Code flow that provides additional security:

- **Code Verifier**: Random string generated by the client
- **Code Challenge**: SHA-256 hash of the code verifier
- **Protection**: Prevents authorization code interception attacks

### Our Implementation

```
Frontend â†’ Backend /initiate â†’ Google OAuth â†’ Backend /callback â†’ JWT Token
```

**Benefits:**

- âœ… More secure than standard Authorization Code flow
- âœ… Client secret never exposed to frontend
- âœ… State parameter validation prevents CSRF attacks
- âœ… Backend generates and verifies PKCE parameters
- âœ… Industry best practice for modern OAuth

---

## Step 1: Google Cloud Console Setup (3 minutes)

### Create OAuth 2.0 Credentials

1. Go to **[Google Cloud Console](https://console.cloud.google.com/)**
2. Select or create a project
3. Navigate to: **APIs & Services â†’ Credentials**
4. Click: **Create Credentials â†’ OAuth client ID**
5. Select: **Web application**

### Configure Authorized Settings

**Authorized JavaScript origins:**

```
http://localhost:5173
https://yourdomain.com
```

**Authorized redirect URIs:**

```
http://localhost:5173/auth/google/callback
https://yourdomain.com/auth/google/callback
```

### Get Your Credentials

After creation, you'll get:

- **Client ID**: `822955738303-xxx...apps.googleusercontent.com`
- **Client Secret**: `GOCSPX-xxx...` (for backend only - keep secret!)

---

## Step 2: Backend Configuration (1 minute)

### Set Environment Variables

The backend should already have PKCE endpoints implemented:

- `POST /api/auth/oauth/google/initiate` â­
- `POST /api/auth/oauth/google/callback` â­
- `POST /api/auth/oauth/google` (Legacy - Deprecated)

Configure your backend environment:

```env
GOOGLE_CLIENT_ID=822955738303-xxx...apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX-xxx...
JWT_SECRET=your-jwt-secret
```

âš ï¸ **IMPORTANT**: Keep `GOOGLE_CLIENT_SECRET` secure! Never expose it in frontend code.

---

## Step 3: Frontend Configuration (1 minute)

### Environment Variable (Optional)

The frontend no longer needs the Google Client ID since the backend handles everything!

Create or update `apps/app/.env`:

```env
VITE_API_BASE=http://localhost:8080
```

That's it! The `VITE_GOOGLE_CLIENT_ID` is no longer needed for PKCE flow. âœ¨

---

## Step 4: Test It! (2 minutes)

### Option A: Start the Application

```bash
# Terminal 1 - Start Backend
./gradlew :app:bootRun
```

Wait for the application to start (look for "Started HeadknotApplication").

```bash
# Terminal 2 - Start Frontend
cd headknot-web
pnpm dev
```

Frontend will be available at `http://localhost:5173`

### Option B: Test via Swagger UI

1. Open http://localhost:8080/api/swagger-ui.html
2. Navigate to the **"identity"** group
3. Find the **OAuth** section
4. You should see 3 endpoints:
    - `POST /api/auth/oauth/google` (Legacy - Deprecated) âš ï¸
    - `POST /api/auth/oauth/google/initiate` (PKCE) â­
    - `POST /api/auth/oauth/google/callback` (PKCE) â­

### Test Initiate Endpoint

In Swagger UI:

1. Click on `POST /api/auth/oauth/google/initiate`
2. Click "Try it out"
3. Click "Execute"

**Expected Response (200 OK):**

```json
{
    "authorizationUrl": "https://accounts.google.com/o/oauth2/v2/auth?client_id=...&code_challenge=...",
    "state": "xyzABC123..."
}
```

### Test Full OAuth Flow

1. Copy the `authorizationUrl` from the response
2. Open it in a browser
3. Authenticate with Google
4. Google will redirect back with `code` and `state`
5. In Swagger UI, use `POST /api/auth/oauth/google/callback`:
    ```json
    {
        "code": "4/0Aean...",
        "state": "xyzABC123..."
    }
    ```
6. You'll receive user info and JWT token!

### End-to-End Test

1. Start backend: `http://localhost:8080`
2. Start frontend: `http://localhost:5173`
3. Navigate to `/login`
4. Click **"Continue with Google"**
5. Authenticate with Google
6. You should be redirected to dashboard âœ…

---

## ðŸ” How It Works

### PKCE Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontendâ”‚                 â”‚ Backend â”‚                 â”‚ Google  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                           â”‚                           â”‚
     â”‚ 1. POST /initiate         â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                           â”‚
     â”‚                           â”‚ 2. Generate PKCE params   â”‚
     â”‚                           â”‚    - code_verifier        â”‚
     â”‚                           â”‚    - code_challenge       â”‚
     â”‚                           â”‚    - state                â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 3. Return authUrl + state â”‚                           â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚  { authorizationUrl,      â”‚                           â”‚
     â”‚    state: "xyz..." }      â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 4. Store state in         â”‚                           â”‚
     â”‚    sessionStorage         â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 5. Redirect to authUrl    â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                           â”‚   (includes code_challenge)â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 6. User Authenticates     â”‚                           â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                           â”‚                           â”‚
     â”‚ 7. Redirect with code     â”‚                           â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚  /callback?code=...       â”‚                           â”‚
     â”‚  &state=xyz...            â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 8. Verify state matches   â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 9. POST /callback         â”‚                           â”‚
     â”‚    { code, state }        â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                           â”‚
     â”‚                           â”‚ 10. Verify state          â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 11. Exchange code         â”‚
     â”‚                           â”‚     with code_verifier    â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 12. Return access token   â”‚
     â”‚                           â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 13. Get user info         â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 14. Return user info      â”‚
     â”‚                           â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 15. Create/Update user    â”‚
     â”‚                           â”‚     Generate JWT token    â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 16. Return JWT + user infoâ”‚                           â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚  { accessToken,           â”‚                           â”‚
     â”‚    userId, email, ... }   â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 17. Store token &         â”‚                           â”‚
     â”‚     redirect to dashboard â”‚                           â”‚
     â”‚                           â”‚                           â”‚
```

### Frontend Implementation

**Login Page (`apps/app/src/pages/Login.tsx`):**

```typescript
const handleGoogleLogin = async () => {
    // Step 1: Call backend to initiate PKCE flow
    const response = await initiateGoogleOAuth();

    // Step 2: Store state for verification
    sessionStorage.setItem('oauth_state', response.state);
    sessionStorage.setItem('oauth_next', '/dashboard');

    // Step 3: Redirect to Google
    window.location.href = response.authorizationUrl;
};
```

**Callback Page (`apps/app/src/pages/GoogleCallback.tsx`):**

```typescript
const code = searchParams.get('code');
const state = searchParams.get('state');

// Step 1: Verify state matches
const storedState = sessionStorage.getItem('oauth_state');
if (storedState !== state) {
    // CSRF attack detected!
    return;
}

// Step 2: Exchange code for token
const data = await handleGoogleOAuthCallback(code, state);

// Step 3: Store JWT token
storage.access = data.accessToken;

// Step 4: Redirect to dashboard
window.location.href = '/dashboard';
```

---

## ðŸ” Security Features

### Why PKCE is More Secure

| Feature                         | Standard Flow       | PKCE Flow           |
| ------------------------------- | ------------------- | ------------------- |
| Authorization Code Interception | âš ï¸ Vulnerable       | âœ… Protected        |
| CSRF Protection                 | âœ… State parameter  | âœ… State parameter  |
| Client Secret Exposure          | âœ… Server-side only | âœ… Server-side only |
| Mobile/SPA Security             | âš ï¸ Less secure      | âœ… Highly secure    |
| Code Replay Attacks             | âš ï¸ Possible         | âœ… Prevented        |

### PKCE Protection Mechanism

1. **Backend generates random `code_verifier`** (43-128 chars)
2. **Creates `code_challenge`** = BASE64URL(SHA256(code_verifier))
3. **Sends code_challenge to Google** during authorization
4. **Stores code_verifier** temporarily (associated with state)
5. **When callback occurs**, backend sends code_verifier to Google
6. **Google verifies** that SHA256(code_verifier) matches code_challenge
7. **If match**, tokens are issued âœ…
8. **If no match**, request is rejected âŒ

This prevents attackers from intercepting the authorization code and using it, since they don't have the code_verifier.

---

## ðŸ› Troubleshooting

### Error: "Invalid response from OAuth initiate endpoint"

**Cause**: Backend `/initiate` endpoint not responding correctly

**Fix**:

- Ensure backend is running on `http://localhost:8080`
- Check backend logs for errors
- Verify `GOOGLE_CLIENT_ID` and `GOOGLE_CLIENT_SECRET` are set

### Error: "State mismatch - possible CSRF attack"

**Cause**: State parameter doesn't match stored value

**Fix**:

- Clear browser's sessionStorage and try again
- Don't open multiple OAuth tabs simultaneously
- Check if backend is properly storing/retrieving state

### Error: "redirect_uri_mismatch"

**Cause**: Redirect URI not configured in Google Console

**Fix**: Add `http://localhost:5173/auth/google/callback` to authorized redirect URIs in Google Cloud Console

### Error: "Error 403: access_denied"

**Cause**: OAuth consent screen in testing mode

**Fix**: Add your Google account to test users in Google Cloud Console â†’ OAuth consent screen

### Frontend Error: "Failed to initiate Google OAuth"

**Checklist**:

- âœ… Backend running on `http://localhost:8080`
- âœ… CORS enabled for `http://localhost:5173`
- âœ… Backend `/auth/oauth/google/initiate` endpoint implemented
- âœ… Network tab shows successful POST request

---

## ðŸ“‹ API Reference

### Initiate Endpoint

**Request:**

```http
POST /api/auth/oauth/google/initiate
Content-Type: application/json
```

**Response:**

```json
{
    "authorizationUrl": "https://accounts.google.com/o/oauth2/v2/auth?client_id=...&redirect_uri=...&response_type=code&scope=openid+email+profile&state=xyz&code_challenge=abc&code_challenge_method=S256",
    "state": "xyz123abc456"
}
```

### Callback Endpoint

**Request:**

```http
POST /api/auth/oauth/google/callback
Content-Type: application/json

{
  "code": "4/0Aean...",
  "state": "xyz123abc456"
}
```

**Response:**

```json
{
    "userId": "user-uuid",
    "email": "user@example.com",
    "givenName": "John",
    "familyName": "Doe",
    "picture": "https://lh3.googleusercontent.com/...",
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresAt": "2024-12-31T23:59:59Z"
}
```

---

## ðŸ“ Files Modified

### Created/Modified

- âœ… `packages/api-client/src/index.ts` - Added PKCE helper functions
- âœ… `apps/app/src/pages/Login.tsx` - Implemented PKCE initiate flow
- âœ… `apps/app/src/pages/Signup.tsx` - Implemented PKCE initiate flow
- âœ… `apps/app/src/pages/GoogleCallback.tsx` - Implemented PKCE callback with state verification
- âœ… `packages/api-client/schema/schema.d.ts` - TypeScript types for PKCE endpoints

### API Client Functions

```typescript
// PKCE Functions (âœ… Recommended)
export async function initiateGoogleOAuth();
export async function handleGoogleOAuthCallback(code: string, state: string);

// Legacy Function (âš ï¸ Deprecated)
export async function googleAuth(code: string);
```

---

## ðŸ“š Comparison: Legacy vs PKCE

### Legacy Flow (Deprecated)

```typescript
// âŒ Less secure - Frontend manages OAuth directly
const handleGoogleLogin = () => {
    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=...`;
    window.location.href = authUrl;
};

// In callback:
const code = searchParams.get('code');
await googleAuth(code); // Backend exchanges code
```

**Issues:**

- Frontend needs Google Client ID
- Less secure (no PKCE protection)
- State management is manual

### PKCE Flow (Current)

```typescript
// âœ… More secure - Backend manages everything
const handleGoogleLogin = async () => {
    const { authorizationUrl, state } = await initiateGoogleOAuth();
    sessionStorage.setItem('oauth_state', state);
    window.location.href = authorizationUrl;
};

// In callback:
const code = searchParams.get('code');
const state = searchParams.get('state');
await handleGoogleOAuthCallback(code, state);
```

**Benefits:**

- No Google Client ID needed in frontend
- PKCE protection against code interception
- State validation on both sides
- Backend fully controls OAuth flow

---

## ðŸš€ Production Checklist

### Google Cloud Console

- [ ] Publish OAuth consent screen for production
- [ ] Add production domain to authorized origins
- [ ] Add production callback URL to authorized redirect URIs
- [ ] Set up separate credentials for staging/production
- [ ] Configure OAuth scopes properly

### Backend

- [ ] `GOOGLE_CLIENT_ID` configured
- [ ] `GOOGLE_CLIENT_SECRET` stored securely (secrets manager)
- [ ] Rate limiting enabled for OAuth endpoints
- [ ] Logging enabled for OAuth events
- [ ] Monitoring/alerts for OAuth failures
- [ ] HTTPS enabled (required for production OAuth)

### Frontend

- [ ] `VITE_API_BASE` points to production API
- [ ] HTTPS enabled (required for OAuth)
- [ ] Error handling tested
- [ ] sessionStorage cleared on logout

### Security

- [ ] PKCE enabled and tested
- [ ] State parameter validation working
- [ ] CSRF protection verified
- [ ] Rate limiting configured
- [ ] Security headers configured (CORS, CSP, etc.)

---

## âœ… Success Criteria

You'll know it's working when:

1. âœ… "Continue with Google" button appears on login page
2. âœ… Clicking button calls `/initiate` endpoint
3. âœ… Redirects to Google authentication page
4. âœ… After authentication, returns to `/auth/google/callback`
5. âœ… State parameter is validated
6. âœ… User is logged in with JWT token
7. âœ… User is redirected to intended destination
8. âœ… User can access protected routes

---

## ðŸ“ž Resources

### Documentation

- [OAuth 2.0 PKCE Specification (RFC 7636)](https://tools.ietf.org/html/rfc7636)
- [Google OAuth 2.0 Documentation](https://developers.google.com/identity/protocols/oauth2)
- [Google Cloud Console](https://console.cloud.google.com/)

### Internal Docs

- `GOOGLE_OAUTH_SUMMARY.md` - Implementation details
- `packages/api-client/schema/schema.d.ts` - TypeScript types

---

**Status**: âœ… Frontend Complete | âœ… Backend Complete (PKCE)

**OAuth Flow**: PKCE (Proof Key for Code Exchange)

**Security Level**: ðŸ”’ðŸ”’ðŸ”’ High (Industry Best Practice)

**Last Updated**: December 2024
