openapi: 3.0.3
info:
    title: Headknot MVP API
    version: 0.1.0
    description: |
        Minimal contract for the Headknot MVP. Covers Auth, Workspaces, Memories
        (with content blocks + provenance), Tags, Attachments (presigned flow),
        Search, and lightweight AI helpers.
servers:
    - url: https://api.headknot.local
      description: Local/dev
    - url: https://api.headknot.app
      description: Production
security:
    - bearerAuth: []

tags:
    - name: Auth
    - name: Users
    - name: Workspaces
    - name: Memories
    - name: Tags
    - name: Assets
    - name: Search
    - name: AI
    - name: System

paths:
    /auth/login:
        post:
            tags: [Auth]
            security: []
            summary: Login with email and password
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/LoginRequest'
            responses:
                '200':
                    description: Authenticated
                    headers:
                        Set-Cookie:
                            description: Refresh token cookie (HttpOnly, Secure)
                            schema:
                                type: string
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/LoginResponse'
                '401': { $ref: '#/components/responses/Unauthorized' }
    /auth/refresh:
        post:
            tags: [Auth]
            security: []
            summary: Refresh access token using refresh cookie
            responses:
                '200':
                    description: Refreshed
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/LoginResponse'
                '401': { $ref: '#/components/responses/Unauthorized' }
    /auth/logout:
        post:
            tags: [Auth]
            summary: Logout and clear refresh cookie
            responses:
                '204': { description: Logged out }

    /users/me:
        get:
            tags: [Users]
            summary: Current user profile
            responses:
                '200':
                    description: OK
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/User'
                '401': { $ref: '#/components/responses/Unauthorized' }

    /workspaces:
        get:
            tags: [Workspaces]
            summary: List workspaces I belong to
            responses:
                '200':
                    description: OK
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    data:
                                        type: array
                                        items:
                                            $ref: '#/components/schemas/Workspace'
        post:
            tags: [Workspaces]
            summary: Create workspace
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/WorkspaceCreate'
            responses:
                '201':
                    description: Created
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Workspace'
    /workspaces/{id}:
        get:
            tags: [Workspaces]
            summary: Read workspace
            parameters:
                - $ref: '#/components/parameters/WorkspaceId'
            responses:
                '200':
                    description: OK
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Workspace'
                '404': { $ref: '#/components/responses/NotFound' }
        patch:
            tags: [Workspaces]
            summary: Update workspace
            parameters:
                - $ref: '#/components/parameters/WorkspaceId'
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/WorkspacePatch'
            responses:
                '200':
                    description: Updated
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Workspace'

    /memories:
        get:
            tags: [Memories]
            summary: List memories with filters
            parameters:
                - $ref: '#/components/parameters/WorkspaceIdQuery'
                - $ref: '#/components/parameters/Q'
                - $ref: '#/components/parameters/Tag'
                - $ref: '#/components/parameters/Kind'
                - $ref: '#/components/parameters/From'
                - $ref: '#/components/parameters/To'
                - $ref: '#/components/parameters/Limit'
                - $ref: '#/components/parameters/Cursor'
            responses:
                '200':
                    description: OK
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/MemoryListResponse'
        post:
            tags: [Memories]
            summary: Create (capture) memory
            parameters:
                - $ref: '#/components/parameters/IdempotencyKey'
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/MemoryCreate'
            responses:
                '201':
                    description: Created
                    headers:
                        ETag:
                            description: Version tag for concurrency control
                            schema: { type: string }
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Memory'
    /memories/{id}:
        get:
            tags: [Memories]
            summary: Read memory by id
            parameters:
                - $ref: '#/components/parameters/MemoryId'
            responses:
                '200':
                    description: OK
                    headers:
                        ETag:
                            schema: { type: string }
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Memory'
                '404': { $ref: '#/components/responses/NotFound' }
        patch:
            tags: [Memories]
            summary: Update memory (JSON Merge Patch)
            parameters:
                - $ref: '#/components/parameters/MemoryId'
                - in: header
                  name: If-Match
                  required: false
                  schema: { type: string }
                  description: Provide ETag for optimistic concurrency
            requestBody:
                required: true
                content:
                    application/merge-patch+json:
                        schema:
                            $ref: '#/components/schemas/MemoryPatch'
            responses:
                '200':
                    description: Updated
                    headers:
                        ETag:
                            schema: { type: string }
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Memory'
        delete:
            tags: [Memories]
            summary: Soft delete (archive) memory
            parameters:
                - $ref: '#/components/parameters/MemoryId'
            responses:
                '204': { description: Deleted }

    /memories/{id}/comments:
        get:
            tags: [Memories]
            summary: List comments
            parameters:
                - $ref: '#/components/parameters/MemoryId'
            responses:
                '200':
                    description: OK
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    data:
                                        type: array
                                        items:
                                            $ref: '#/components/schemas/Comment'
        post:
            tags: [Memories]
            summary: Add comment
            parameters:
                - $ref: '#/components/parameters/MemoryId'
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/CommentCreate'
            responses:
                '201':
                    description: Created
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Comment'

    /memories/{id}/tags:
        post:
            tags: [Tags]
            summary: Replace memory tags (idempotent)
            parameters:
                - $ref: '#/components/parameters/MemoryId'
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                tags:
                                    type: array
                                    items: { type: string }
            responses:
                '200':
                    description: Updated
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Memory'

    /tags:
        get:
            tags: [Tags]
            summary: List tags in a workspace (prefix match)
            parameters:
                - $ref: '#/components/parameters/WorkspaceIdQuery'
                - name: prefix
                  in: query
                  schema: { type: string }
            responses:
                '200':
                    description: OK
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    data:
                                        type: array
                                        items:
                                            $ref: '#/components/schemas/Tag'
        post:
            tags: [Tags]
            summary: Create or upsert tag
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/TagCreate'
            responses:
                '201':
                    description: Created
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Tag'

    /assets/uploads:
        post:
            tags: [Assets]
            summary: Initiate presigned upload
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/AssetUploadInit'
            responses:
                '201':
                    description: Upload initiated
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/AssetUploadInitResponse'
    /assets/{asset_id}/finalize:
        post:
            tags: [Assets]
            summary: Finalize uploaded asset (scan + metadata)
            parameters:
                - $ref: '#/components/parameters/AssetId'
            responses:
                '200':
                    description: Finalized asset
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Asset'
    /assets/{asset_id}:
        get:
            tags: [Assets]
            summary: Get asset metadata (and optionally a signed URL)
            parameters:
                - $ref: '#/components/parameters/AssetId'
                - name: signed_url
                  in: query
                  schema: { type: boolean, default: false }
            responses:
                '200':
                    description: OK
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Asset'
                '404': { $ref: '#/components/responses/NotFound' }

    /search:
        get:
            tags: [Search]
            summary: Search memories (basic text + filters)
            parameters:
                - $ref: '#/components/parameters/WorkspaceIdQuery'
                - $ref: '#/components/parameters/Q'
                - $ref: '#/components/parameters/Tag'
                - $ref: '#/components/parameters/Kind'
                - $ref: '#/components/parameters/From'
                - $ref: '#/components/parameters/To'
                - $ref: '#/components/parameters/Limit'
                - $ref: '#/components/parameters/Cursor'
            responses:
                '200':
                    description: OK
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/SearchResponse'

    /ai/generate-title:
        post:
            tags: [AI]
            summary: Generate a concise title from blocks
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                blocks:
                                    type: array
                                    items:
                                        {
                                            $ref: '#/components/schemas/MemoryBlock',
                                        }
            responses:
                '200':
                    description: OK
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    title: { type: string }

    /ai/summarize:
        post:
            tags: [AI]
            summary: Summarize a memory or provided blocks
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                memory_id: { type: string }
                                blocks:
                                    type: array
                                    items:
                                        {
                                            $ref: '#/components/schemas/MemoryBlock',
                                        }
            responses:
                '200':
                    description: OK
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    summary: { type: string }

    /health:
        get:
            tags: [System]
            security: []
            summary: Liveness probe
            responses:
                '200': { description: OK }
    /ready:
        get:
            tags: [System]
            security: []
            summary: Readiness probe (DB/migrations)
            responses:
                '200': { description: OK }

components:
    securitySchemes:
        bearerAuth:
            type: http
            scheme: bearer
            bearerFormat: JWT
    parameters:
        WorkspaceId:
            name: id
            in: path
            required: true
            schema: { type: string }
        WorkspaceIdQuery:
            name: workspace_id
            in: query
            required: true
            schema: { type: string }
        MemoryId:
            name: id
            in: path
            required: true
            schema: { type: string }
        AssetId:
            name: asset_id
            in: path
            required: true
            schema: { type: string }
        Q:
            name: q
            in: query
            schema: { type: string }
        Tag:
            name: tag
            in: query
            schema: { type: string }
        Kind:
            name: kind
            in: query
            schema:
                $ref: '#/components/schemas/MemoryKind'
        From:
            name: from
            in: query
            schema: { type: string, format: date-time }
        To:
            name: to
            in: query
            schema: { type: string, format: date-time }
        Limit:
            name: limit
            in: query
            schema: { type: integer, minimum: 1, maximum: 100, default: 50 }
        Cursor:
            name: cursor
            in: query
            schema: { type: string }
        IdempotencyKey:
            name: Idempotency-Key
            in: header
            required: false
            schema: { type: string }
    responses:
        Unauthorized:
            description: Unauthorized
            content:
                application/json:
                    schema: { $ref: '#/components/schemas/ErrorResponse' }
        NotFound:
            description: Not found
            content:
                application/json:
                    schema: { $ref: '#/components/schemas/ErrorResponse' }
    schemas:
        ErrorResponse:
            type: object
            properties:
                error:
                    type: object
                    properties:
                        code: { type: string }
                        message: { type: string }
                        details: { type: object, additionalProperties: true }
                    required: [code, message]
            required: [error]

        LoginRequest:
            type: object
            properties:
                email: { type: string, format: email }
                password: { type: string, minLength: 6 }
            required: [email, password]
        LoginResponse:
            type: object
            properties:
                access_token: { type: string }
                token_type: { type: string, default: Bearer }
                expires_in: { type: integer, example: 3600 }
            required: [access_token]

        User:
            type: object
            properties:
                id: { type: string }
                email: { type: string, format: email }
                name: { type: string }
                created_at: { type: string, format: date-time }

        Workspace:
            type: object
            properties:
                id: { type: string }
                name: { type: string }
                icon: { type: string, nullable: true }
                owner_id: { type: string }
                created_at: { type: string, format: date-time }
            required: [id, name]
        WorkspaceCreate:
            type: object
            properties:
                name: { type: string }
                icon: { type: string, nullable: true }
            required: [name]
        WorkspacePatch:
            type: object
            properties:
                name: { type: string }
                icon: { type: string, nullable: true }

        MemoryKind:
            type: string
            enum: [note, link, code, file, image, highlight, quote]

        Memory:
            type: object
            properties:
                id: { type: string }
                workspace_id: { type: string }
                kind: { $ref: '#/components/schemas/MemoryKind' }
                title: { type: string, nullable: true }
                tags:
                    type: array
                    items: { type: string }
                provenance:
                    type: object
                    description: Either parent_id is set or this memory is a root capture.
                    properties:
                        parent_id: { type: string, nullable: true }
                        is_root: { type: boolean, default: false }
                blocks:
                    type: array
                    items: { $ref: '#/components/schemas/MemoryBlock' }
                created_by: { type: string }
                created_at: { type: string, format: date-time }
                updated_at: { type: string, format: date-time }
                deleted_at: { type: string, format: date-time, nullable: true }
            required: [id, workspace_id, kind, blocks, created_at]

        MemoryCreate:
            type: object
            properties:
                workspace_id: { type: string }
                kind: { $ref: '#/components/schemas/MemoryKind' }
                title: { type: string, nullable: true }
                provenance:
                    type: object
                    properties:
                        parent_id: { type: string, nullable: true }
                blocks:
                    type: array
                    items: { $ref: '#/components/schemas/MemoryBlock' }
                tags:
                    type: array
                    items: { type: string }
            required: [workspace_id, kind, blocks]

        MemoryPatch:
            type: object
            description: JSON Merge Patch shape
            properties:
                title: { type: string, nullable: true }
                provenance:
                    type: object
                    properties:
                        parent_id: { type: string, nullable: true }
                        is_root: { type: boolean }
                blocks:
                    type: array
                    items: { $ref: '#/components/schemas/MemoryBlock' }
                tags:
                    type: array
                    items: { type: string }

        MemoryBlock:
            type: object
            required: [type]
            properties:
                id: { type: string, nullable: true }
                type:
                    type: string
                    enum: [text, link, code, file, image, quote, highlight]
            oneOf:
                - properties:
                      type: { type: string, enum: [$1] }
                      text: { type: string }
                  required: [text]
                - properties:
                      type: { type: string, enum: [$1] }
                      url: { type: string, format: uri }
                  required: [url]
                - properties:
                      type: { type: string, enum: [$1] }
                      language: { type: string }
                      code: { type: string }
                  required: [language, code]
                - properties:
                      type: { type: string, enum: [$1] }
                      asset_id: { type: string }
                      name: { type: string, nullable: true }
                  required: [asset_id]
                - properties:
                      type: { type: string, enum: [$1] }
                      asset_id: { type: string }
                  required: [asset_id]
                - properties:
                      type: { type: string, enum: [$1] }
                      text: { type: string }
                      source: { type: string, nullable: true }
                  required: [text]
                - properties:
                      type: { type: string, enum: [$1] }
                      text: { type: string }
                      source_url: { type: string, format: uri, nullable: true }
                  required: [text]
            discriminator:
                propertyName: type

        MemoryListResponse:
            type: object
            properties:
                data:
                    type: array
                    items: { $ref: '#/components/schemas/Memory' }
                next_cursor: { type: string, nullable: true }

        Comment:
            type: object
            properties:
                id: { type: string }
                memory_id: { type: string }
                author_id: { type: string }
                text: { type: string }
                created_at: { type: string, format: date-time }
            required: [id, memory_id, author_id, text, created_at]
        CommentCreate:
            type: object
            properties:
                text: { type: string }
            required: [text]

        Tag:
            type: object
            properties:
                id: { type: string }
                workspace_id: { type: string }
                name: { type: string }
            required: [id, workspace_id, name]
        TagCreate:
            type: object
            properties:
                workspace_id: { type: string }
                name: { type: string }
            required: [workspace_id, name]

        AssetStatus:
            type: string
            enum: [pending, uploaded, finalized, failed]
        Asset:
            type: object
            properties:
                id: { type: string }
                workspace_id: { type: string }
                kind: { type: string, enum: [file, image] }
                mime: { type: string }
                size: { type: integer }
                sha256: { type: string }
                status: { $ref: '#/components/schemas/AssetStatus' }
                signed_url: { type: string, format: uri, nullable: true }
                created_by: { type: string }
                created_at: { type: string, format: date-time }
            required: [id, workspace_id, kind, status]
        AssetUploadInit:
            type: object
            properties:
                workspace_id: { type: string }
                kind: { type: string, enum: [file, image] }
                mime: { type: string }
                size: { type: integer }
            required: [workspace_id, kind, mime, size]
        AssetUploadInitResponse:
            type: object
            properties:
                asset_id: { type: string }
                upload_url: { type: string, format: uri }
                headers:
                    type: object
                    additionalProperties: { type: string }
            required: [asset_id, upload_url]

        SearchHit:
            type: object
            properties:
                memory: { $ref: '#/components/schemas/Memory' }
                highlight: { type: string }
            required: [memory]
        SearchResponse:
            type: object
            properties:
                data:
                    type: array
                    items: { $ref: '#/components/schemas/SearchHit' }
                next_cursor: { type: string, nullable: true }
